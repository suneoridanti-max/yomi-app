
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—èª­ã¿æ–¹ ã‚¯ã‚¤ã‚º</title>
    <style>
        :root {
            --primary-color: #007bff;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --background-color: #f4f7f6;
            --text-color: #333;
            --light-gray: #e9ecef;
            --ruby-color: #ffc107; /* ãƒ«ãƒ“ãƒ¼ã®è‰² */
            --sapphire-color: #007bff; /* ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã®è‰² */
            --emerald-color: #28a745; /* ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®è‰²ã‚’è¿½åŠ  */
            --true-diamond-color: #aaa; /* ãƒ€ã‚¤ãƒ¤ã®è‰² */
            --test-button-color: #6f42c1; /* ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®è‰² */
            --review-button-color: #ff8c00; /* å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®è‰² */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            padding: 30px;
            text-align: center;
            margin-top: 30px;
        }
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2em;
        }
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .hidden {
            display: none !important;
        }

        /* ===== ç”»é¢å…±é€š ===== */
        .screen {
            animation: fadeIn 0.5s ease-in-out;
        }
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: #5a6268;
        }

        /* ===== ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ ===== */
        #header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light-gray);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #total-questions-display {
            font-size: 1.1em;
            font-weight: bold;
        }
        /* ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
        #ruby-display, #sapphire-display, #emerald-display, #true-diamond-display {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
            transition: all 0.5s ease;
            display: inline-block;
            margin-left: 10px;
        }
        #ruby-display::before {
            content: 'ğŸ”´';
            margin-right: 8px;
            transition: all 0.5s ease;
            display: inline-block;
            text-shadow: 0 0 5px var(--ruby-color);
        }
        #sapphire-display::before {
            content: 'ğŸ”µ';
            margin-right: 8px;
            transition: all 0.5s ease;
            display: inline-block;
            text-shadow: 0 0 5px var(--sapphire-color);
        }
        /* ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
        #emerald-display::before {
            content: 'ğŸŸ¢';
            margin-right: 8px;
            transition: all 0.5s ease;
            display: inline-block;
            text-shadow: 0 0 5px var(--emerald-color);
        }
        #true-diamond-display::before {
            content: 'ğŸ’';
            margin-right: 8px;
            transition: all 0.5s ease;
            display: inline-block;
            text-shadow: 0 0 5px var(--true-diamond-color);
        }
        #ruby-display.tier-1::before { content: 'ğŸ”´'; text-shadow: 0 0 5px var(--ruby-color); }
        #ruby-display.tier-2::before { content: 'ğŸŸ '; text-shadow: 0 0 8px orange; }
        #ruby-display.tier-3::before { content: 'ğŸŸ¡'; text-shadow: 0 0 10px yellow; }
        #ruby-display.tier-4::before { content: 'ğŸŸ¢'; text-shadow: 0 0 12px lightgreen; transform: scale(1.2); }

        #main-menu-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 40px auto;
            max-width: 400px;
        }
        .main-menu-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 25px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .main-menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        #go-to-item-exchange-button {
            background-color: var(--correct-color);
        }
        
        /* ã€Œèªå½™ç‹ã¸ã®é“ã€ã®é€²æ—è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        #oilyou-progress-container {
            margin: 20px auto 0;
            max-width: 400px;
            text-align: center;
        }
        #oilyou-progress-container p {
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .progress-bar-background {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .progress-bar-foreground {
            height: 100%;
            width: 0%; /* JavaScriptã§å¹…ã‚’æ“ä½œã—ã¾ã™ */
            background: linear-gradient(to right, #76b852, #8DC26F);
            border-radius: 10px 0 0 10px;
            transition: width 0.5s ease-in-out;
        }
        #oilyou-progress-details {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 10px;
            margin-top: 8px;
        }
        #oilyou-progress-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }
        #oilyou-progress-count {
            font-size: 0.9em;
            color: #555;
            font-weight: bold;
        }


        /* ===== ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠç”»é¢ ===== */
        #stage-selection-grid, #test-selection-grid, #review-stage-selection-grid, #comprehension-review-stage-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        #reading-comprehension-stage-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background-color: #fafafa;
        }
        .random-stage-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            flex-wrap: wrap;
            justify-content: center;
        }
        .random-stage-controls label {
            font-weight: bold;
        }
        .random-stage-controls select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
            cursor: pointer;
        }
        #reading-comprehension-stage-button {
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }

        .stage-button, .test-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .stage-button:hover, .test-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .stage-button.locked, .test-button.locked {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .stage-button.locked::after, .test-button.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            opacity: 0.7;
        }
        .stage-button .clear-mark, .test-button .clear-mark {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            font-size: 0.8em;
            color: var(--ruby-color);
            text-shadow: 0 0 3px black;
            letter-spacing: 2px;
        }
        .test-button {
            background-color: var(--test-button-color);
        }
        .stage-button.review-stage {
             background-color: var(--review-button-color);
        }

        /* ===== ã‚¯ã‚¤ã‚ºç”»é¢ ===== */
        #quiz-container, #quiz-content {
            cursor: default;
        }
        #question-number { font-size: 1.1em; color: #555; margin-bottom: 15px; }
        #comprehension-instruction {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 5px;
            min-height: 1.2em;
        }
        #comprehension-word {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            min-height: 2.2em;
        }
        #sentence { font-size: 1.6em; margin-bottom: 30px; line-height: 1.6; }
        #sentence u { text-decoration: none; border-bottom: 3px solid var(--primary-color); padding-bottom: 2px; font-weight: bold; }
        .choices-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; width: 100%; margin: 20px auto 0; }
        .choices-grid.comprehension {
             grid-template-columns: 1fr;
             max-width: 600px;
        }
        .choices-grid.comprehension.compact-choices {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            max-width: none;
        }
        .choices-grid.comprehension.compact-choices .choice-button {
            text-align: center;
        }
        .choice-button { background-color: var(--light-gray); border: 2px solid var(--light-gray); border-radius: 8px; padding: 15px 20px; font-size: 1.2em; cursor: pointer; transition: all 0.3s ease; text-align: left;}
        .choice-button:hover { background-color: #d0d7dd; border-color: #d0d7dd; }
        .choice-button.correct { background-color: var(--correct-color); color: white; border-color: var(--correct-color); }
        .choice-button.incorrect { background-color: var(--incorrect-color); color: white; border-color: var(--incorrect-color); }
        #feedback { margin-top: 25px; font-size: 1.4em; font-weight: bold; min-height: 25px; }
        #feedback.correct { color: var(--correct-color); }
        #feedback.incorrect { color: var(--incorrect-color); }
        #word-meaning { margin-top: 10px; font-size: 1.1em; color: #666; line-height: 1.5; min-height: 40px; }
        #word-meaning .word-display { color: var(--incorrect-color); font-weight: bold; }
        #word-meaning .meaning-display { margin-left: 8px; }

        /* ===== çµæœç”»é¢ ===== */
        #result-page h2 { font-size: 1.8em; }
        #score { font-size: 2em; margin-bottom: 20px; color: var(--correct-color); }
        #quiz-results-list {
            text-align: left; margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 15px; border-radius: 8px;
        }
        #quiz-results-list li {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #eee;
        }
        #quiz-results-list li:last-child {
            border-bottom: none;
        }
        #quiz-results-list .result-correct {
            color: var(--correct-color);
            font-weight: bold;
        }
        #quiz-results-list .result-incorrect {
            color: var(--incorrect-color);
            font-weight: bold;
        }
        #quiz-results-list .correct-answer-display {
            color: #555;
            font-size: 0.9em;
        }
        #retry-button, #all-retry-button, #back-to-stage-select-button, #next-stage-button { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            padding: 12px 25px; 
            font-size: 1.1em; 
            cursor: pointer; 
            margin: 15px 10px; 
            transition: background-color 0.3s ease;
        }
        #retry-button { background-color: var(--ruby-color); color: var(--text-color); }
        #result-page #retry-button.hidden { display: none; }
        #next-stage-button { background-color: var(--correct-color); }
        #next-stage-button:hover { background-color: #218838; }


        /* ===== ãƒ‡ãƒ¼ã‚¿ç®¡ç† ===== */
        #data-management { margin-top: 30px; }
        .data-button { background-color: #17a2b8; color: white; border: none; padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .data-button:hover { background-color: #138496; }
        #import-file-input { display: none; }

        /* ===== ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›æ‰€ & äº¤æ›å±¥æ­´ ===== */
        #go-to-history-button {
            background-color: var(--test-button-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 20px 10px 0;
            transition: background-color 0.3s ease;
        }
        #go-to-history-button:hover {
            background-color: #5a379a;
        }
        #item-exchange-shop {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
        }
        .item-card {
            background-color: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        .item-card .item-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            min-height: 40px; /* To align items */
        }
        .item-card .item-cost {
            margin-bottom: 15px;
            font-size: 1em;
        }
        .item-card .item-cost .ruby-icon {
            color: var(--ruby-color);
            font-weight: bold;
        }
        .exchange-button {
            background-color: var(--correct-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        .exchange-button:hover {
            background-color: #218838;
        }
        .exchange-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #exchange-history-list {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        #exchange-history-list ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #exchange-history-list li {
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
        }
        #exchange-history-list li:last-child {
            border-bottom: none;
        }
        #exchange-history-list .history-date {
            font-size: 0.8em;
            color: #666;
            margin-left: 10px;
        }

        /* ===== ã‚¹ãƒ”ãƒŠãƒ¼ ===== */
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease infinite; margin: 50px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ===== å®çŸ³ç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
        #gem-animation-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 9999; pointer-events: none;
        }
        .gem-burst { position: absolute; font-size: 3em; animation: burst 1.5s ease-out forwards; }
        .gem-burst.ruby { color: var(--ruby-color); }
        .gem-burst.sapphire { color: var(--sapphire-color); }
        /* ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
        .gem-burst.emerald { color: var(--emerald-color); }
        .gem-burst.trueDiamond { color: var(--true-diamond-color); }

        @keyframes burst {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0.5) translateY(-500px) rotate(360deg); opacity: 0; }
        }
        #gem-gain-text {
            position: absolute; font-size: 3em; font-weight: bold; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); animation: gain-text 1.5s ease-out forwards;
        }
        #gem-gain-text.ruby { color: var(--ruby-color); }
        #gem-gain-text.sapphire { color: var(--sapphire-color); }
        /* ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
        #gem-gain-text.emerald { color: var(--emerald-color); }
        #gem-gain-text.trueDiamond { color: var(--true-diamond-color); }

        @keyframes gain-text {
            0% { transform: scale(0.5); opacity: 0; }
            40% { transform: scale(1.2); opacity: 1; }
            60% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>
    <div class="container">
        <!-- Main Menu Screen -->
        <div id="main-menu-screen" class="screen">
            <h1>æ¼¢å­—èª­ã¿æ–¹ ã‚¯ã‚¤ã‚º</h1>
            <div id="header-info">
                <p id="total-questions-display">å…¨500å•</p>
                <div>
                    <p id="ruby-display" class="tier-1">0</p>
                    <p id="sapphire-display">0</p>
                    <!-- ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è¡¨ç¤ºã‚’è¿½åŠ  -->
                    <p id="emerald-display">0</p>
                    <p id="true-diamond-display">0</p>
                </div>
            </div>
            <div id="main-menu-container" style="max-width: 400px; margin: 40px auto;">
                <div id="main-menu-buttons">
                    <button id="go-to-stage-select-button" class="main-menu-button">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ</button>
                    <button id="go-to-oilyou-mode-button" class="main-menu-button" style="background-color: #8A2BE2;">èªå½™ç‹ã¸ã®é“</button>
                    <button id="go-to-item-exchange-button" class="main-menu-button">ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›</button>
                </div>
                <div id="oilyou-progress-container">
                    <p>ç·åˆé”æˆç‡</p>
                    <div class="progress-bar-background">
                        <div id="oilyou-progress-bar" class="progress-bar-foreground"></div>
                    </div>
                    <div id="oilyou-progress-details">
                        <span id="oilyou-progress-text">0%</span>
                        <span id="oilyou-progress-count">(0/0å•)</span>
                    </div>
                </div>
            </div>
            <div id="data-management">
                <button id="export-button" class="data-button">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                <button id="import-button" class="data-button">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼</button>
                <input type="file" id="import-file-input" accept=".json">
            </div>
        </div>

        <!-- Stage Select Screen -->
        <div id="stage-select-screen" class="screen hidden">
            <h2>å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸</h2>
            <div id="review-stage-selection-grid"></div>

            <h2>èª­è§£å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸</h2>
            <div id="comprehension-review-stage-selection-grid"></div>

            <h2>ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆèª­è§£ï¼‰ã‚¹ãƒ†ãƒ¼ã‚¸</h2>
            <div id="reading-comprehension-stage-container">
                <div class="random-stage-controls">
                    <label for="rc-start-stage">ç¯„å›²:</label>
                    <select id="rc-start-stage"></select>
                    <span>ã€œ</span>
                    <select id="rc-end-stage"></select>
                </div>
                <button id="reading-comprehension-stage-button" class="stage-button" style="background-color: #17a2b8;">æŒ‘æˆ¦ï¼</button>
            </div>

            <h2>ã‚¹ãƒ†ãƒ¼ã‚¸ã‚»ãƒ¬ã‚¯ãƒˆ</h2>
            <div id="stage-selection-grid"></div>
            
            <div id="unlock-message" class="hidden">
                <p>æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼</p>
            </div>

            <h2>ã‚¹ãƒ†ãƒ¼ã‚¸çµ‚äº†ç¢ºèªãƒ†ã‚¹ãƒˆ</h2>
            <div id="test-selection-grid"></div>
            <button id="back-to-menu-from-stage-select" class="back-button">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
        </div>

        <!-- Item Exchange Screen -->
        <div id="item-exchange-screen" class="screen hidden">
            <h2>ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›æ‰€</h2>
            <div id="item-exchange-shop"></div>
            <button id="go-to-history-button">äº¤æ›å±¥æ­´ã‚’è¦‹ã‚‹</button>
            <button id="back-to-menu-from-exchange" class="back-button">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
        </div>

        <!-- Exchange History Screen -->
        <div id="exchange-history-screen" class="screen hidden">
            <h2>äº¤æ›å±¥æ­´</h2>
            <div id="exchange-history-list"></div>
            <button id="back-to-exchange-button" class="back-button">ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›æ‰€ã¸æˆ»ã‚‹</button>
        </div>


        <div id="quiz-container" class="hidden">
            <div id="loading-spinner" class="spinner"></div>
            <div id="quiz-content" class="hidden">
                <p id="question-number"></p>
                <p id="comprehension-instruction"></p>
                <div id="comprehension-word"></div>
                <p id="sentence"></p>
                <div id="choices" class="choices-grid"></div>
                <div id="feedback"></div>
                <div id="word-meaning"></div>
            </div>
        </div>

        <div id="result-page" class="hidden">
            <h2 id="result-title">çµæœç™ºè¡¨ï¼</h2>
            <p id="score"></p>
            <div id="quiz-results-list"></div>
            <button id="next-stage-button" class="hidden">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«æŒ‘æˆ¦</button>
            <button id="retry-button" class="hidden">é–“é•ãˆãŸå•é¡Œã«å†æŒ‘æˆ¦</button>
            <button id="all-retry-button">åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚‚ã†ä¸€åº¦</button>
            <button id="back-to-stage-select-button">ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã¸æˆ»ã‚‹</button>
        </div>

        <div id="gem-animation-container"></div>
    </div>

    <script>
        // ===== å•é¡Œãƒ‡ãƒ¼ã‚¿ =====
        const allQuizData = [
            // ... (å•é¡Œãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ...
{ "sentence": "ä¼èª¬ã®ç”Ÿãç‰©ã¯ã€<u>å¹»</u>ã®ã‚ˆã†ã«å§¿ã‚’ç¾ã—ã¦ã¯ã™ãã«æ¶ˆãˆã¦ã—ã¾ã†ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚", "sentence2": "ç–²ã‚Œã™ãã¦ã€ç›®ã®å‰ã«<u>å¹»</u>ãŒè¦‹ãˆãŸã‚ˆã†ãªæ°—ãŒã—ãŸã€‚", "word_to_read": "å¹»", "correct_reading": "ã¾ã¼ã‚ã—", "meaning": "å®Ÿéš›ã«ã¯ãªã„ã®ã«ã€ã‚ã‚‹ã‹ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‚‚ã®ã€‚ã¾ãŸã¯ã€ã™ãã«æ¶ˆãˆã¦ã—ã¾ã†ã¯ã‹ãªã„ã‚‚ã®ã®ãŸã¨ãˆã€‚", "choices": ["ã¾ã¼ã‚ã—", "ã’ã‚“", "ã‚†ã‚", "ã¾ã“ã¨", "ã†ã¤ã¤"] },
// ... (ä»¥ä¸‹ã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒç¶šãã¾ã™) ...
        ];
        // ===== ã“ã“ã¾ã§å•é¡Œãƒ‡ãƒ¼ã‚¿ =====

        allQuizData.forEach((question, index) => {
            question.id = index;
        });

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»DOMè¦ç´  ---
    const mainMenuScreen = document.getElementById('main-menu-screen');
    const stageSelectScreen = document.getElementById('stage-select-screen');
    const itemExchangeScreen = document.getElementById('item-exchange-screen');
    const exchangeHistoryScreen = document.getElementById('exchange-history-screen');
    const quizContainer = document.getElementById('quiz-container');
    const resultPage = document.getElementById('result-page');
    const quizContent = document.getElementById('quiz-content');
    const loadingSpinner = document.getElementById('loading-spinner');
    const questionNumberElem = document.getElementById('question-number');
    const sentenceElem = document.getElementById('sentence');
    const choicesElem = document.getElementById('choices');
    const feedbackElem = document.getElementById('feedback');
    const wordMeaningElem = document.getElementById('word-meaning');
    const backToStageSelectButton = document.getElementById('back-to-stage-select-button');
    const scoreElem = document.getElementById('score');
    const quizResultsList = document.getElementById('quiz-results-list');
    const retryButton = document.getElementById('retry-button');
    const allRetryButton = document.getElementById('all-retry-button');
    const nextStageButton = document.getElementById('next-stage-button');
    const stageSelectionGrid = document.getElementById('stage-selection-grid');
    const testSelectionGrid = document.getElementById('test-selection-grid');
    const reviewStageSelectionGrid = document.getElementById('review-stage-selection-grid');
    const comprehensionReviewStageSelectionGrid = document.getElementById('comprehension-review-stage-selection-grid');
    const rubyDisplay = document.getElementById('ruby-display');
    const sapphireDisplay = document.getElementById('sapphire-display');
    const emeraldDisplay = document.getElementById('emerald-display'); // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è¡¨ç¤ºè¦ç´ å–å¾—
    const trueDiamondDisplay = document.getElementById('true-diamond-display');
    const totalQuestionsDisplay = document.getElementById('total-questions-display');
    const gemAnimationContainer = document.getElementById('gem-animation-container');
    const unlockMessage = document.getElementById('unlock-message');
    const exportButton = document.getElementById('export-button');
    const importButton = document.getElementById('import-button');
    const importFileInput = document.getElementById('import-file-input');
    const itemExchangeShop = document.getElementById('item-exchange-shop');
    const exchangeHistoryList = document.getElementById('exchange-history-list');
    const goToStageSelectButton = document.getElementById('go-to-stage-select-button');
    const goToItemExchangeButton = document.getElementById('go-to-item-exchange-button');
    const goToHistoryButton = document.getElementById('go-to-history-button');
    const backToExchangeButton = document.getElementById('back-to-exchange-button');
    const comprehensionInstructionElem = document.getElementById('comprehension-instruction');
    const comprehensionWordElem = document.getElementById('comprehension-word');
    const readingComprehensionStageButton = document.getElementById('reading-comprehension-stage-button');
    const rcStartStageSelect = document.getElementById('rc-start-stage');
    const rcEndStageSelect = document.getElementById('rc-end-stage');
    const goToOilyouModeButton = document.getElementById('go-to-oilyou-mode-button');
    const resultTitle = document.getElementById('result-title');


    // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
    const gameConfig = {
        questionsPerStage: 12,
        questionsPerRandomStage: 15,
        questionsPerTest: 20,
        questionsPerReviewStage: 15,
        questionsPerReadingComprehensionStage: 12,
        stagesPerBlock: 5,
        totalStages: Math.ceil(allQuizData.length / 12),
        initialUnlockedStages: 5,
        unlockIncrement: 5,
    };

    // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
    let playerData = {};
    let currentQuizData = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let incorrectQuestions = [];
    let incorrectQuestionsForRetry = [];
    let isAnswered = false;
    let currentStageId = '';
    let isRetryMode = false;
    let isTestMode = false;
    let isReviewStage = false;
    let isReadingComprehensionStage = false;
    let isComprehensionReviewStage = false;
    let isOilyouMode = false;
    let quizAttemptResults = [];
    
    const PROGRESS_STORAGE_KEY = 'kanjiYomiOilyouProgressData';
    let oilyouProgressData = {};


    // --- ã€Œèªå½™ç‹ã¸ã®é“ã€é–¢é€£ã®é–¢æ•° ---
    function loadOilyouProgress() {
        try {
            const savedData = localStorage.getItem(PROGRESS_STORAGE_KEY);
            oilyouProgressData = savedData ? JSON.parse(savedData) : {};
        } catch (e) {
            console.error('ã€Œèªå½™ç‹ã¸ã®é“ã€ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            oilyouProgressData = {};
        }
    }

    function saveOilyouProgress(progressData) {
        try {
            localStorage.setItem(PROGRESS_STORAGE_KEY, JSON.stringify(progressData));
        } catch (e) {
            console.error('ã€Œèªå½™ç‹ã¸ã®é“ã€ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
        }
    }

    function _calculateWordProgress(wordIndex, progressData) {
        const progress = progressData[String(wordIndex)];
        const totalForms = 5;
        if (!progress) {
            return { completed: 0, total: totalForms };
        }
        let completed = 0;
        if (progress.form1) completed++;
        if (progress.form2) completed++;
        if (progress.form3) completed++;
        if (progress.form4) completed++;
        if (progress.form5) completed++;
        return { completed, total: totalForms };
    }
    
    function createOilyouRandomQuizList(allWords, clearedStageWordIndexes) {
        const quizPool = [];
        for (let i = 0; i < allWords.length; i++) {
            if (!clearedStageWordIndexes.has(i)) {
                continue;
            }
            const progress = _calculateWordProgress(i, oilyouProgressData);
            if (progress.completed === progress.total) {
                continue;
            }
            const wordProgress = oilyouProgressData[String(i)] || {};
            if (!wordProgress.form1) quizPool.push({ wordIndex: i, formId: 1 });
            if (!wordProgress.form2) quizPool.push({ wordIndex: i, formId: 2 });
            if (!wordProgress.form3) quizPool.push({ wordIndex: i, formId: 3 });
            if (!wordProgress.form4) quizPool.push({ wordIndex: i, formId: 4 });
            if (!wordProgress.form5) quizPool.push({ wordIndex: i, formId: 5 });
        }
        for (let i = quizPool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [quizPool[i], quizPool[j]] = [quizPool[j], quizPool[i]];
        }
        const quizList = quizPool.slice(0, 15).map(item => {
            const progress = _calculateWordProgress(item.wordIndex, oilyouProgressData);
            return {
                ...item,
                questionWord: allWords[item.wordIndex],
                progressText: `${progress.completed}/${progress.total} å®Œäº†`
            };
        });
        return quizList;
    }

    function updateOilyouProgress(wordIndex, formId, isFirstTimeCorrect) {
        if (!isFirstTimeCorrect) {
            return;
        }
        const key = String(wordIndex);
        if (!oilyouProgressData[key]) {
            oilyouProgressData[key] = {};
        }
        oilyouProgressData[key][`form${formId}`] = true;
        saveOilyouProgress(oilyouProgressData);
    }

    function calculateOilyouDetailedStats(allWords, progressData) {
        let totalCompletedForms = 0;
        const totalFormsPerWord = 5;
        let totalAllForms = allWords.length * totalFormsPerWord;
        if (!allWords || allWords.length === 0) {
            return { totalCompletedForms: 0, totalAllForms: 0 };
        }
        for (let i = 0; i < allWords.length; i++) {
            const progress = progressData[String(i)];
            if (progress) {
                if (progress.form1) totalCompletedForms++;
                if (progress.form2) totalCompletedForms++;
                if (progress.form3) totalCompletedForms++;
                if (progress.form4) totalCompletedForms++;
                if (progress.form5) totalCompletedForms++;
            }
        }
        return { totalCompletedForms, totalAllForms };
    }
    
    function calculateOilyouCompletionRate(allWords) {
        if (!allWords || allWords.length === 0) {
            return 0;
        }
        const detailedStats = calculateOilyouDetailedStats(allWords, oilyouProgressData);
        if (detailedStats.totalAllForms === 0) {
            return 0;
        }
        return (detailedStats.totalCompletedForms / detailedStats.totalAllForms) * 100;
    }

    function updateOilyouProgressDisplay() {
        if (!allQuizData || allQuizData.length === 0) return;
        loadOilyouProgress();
        const completionRate = calculateOilyouCompletionRate(allQuizData);
        const roundedRate = completionRate.toFixed(2);
        const detailedStats = calculateOilyouDetailedStats(allQuizData, oilyouProgressData);
        const progressBar = document.getElementById('oilyou-progress-bar');
        const progressText = document.getElementById('oilyou-progress-text');
        const progressCount = document.getElementById('oilyou-progress-count');
        if (progressBar && progressText && progressCount) {
            progressBar.style.width = `${completionRate}%`;
            progressText.textContent = `${roundedRate}%`;
            progressCount.textContent = `(${detailedStats.totalCompletedForms}/${detailedStats.totalAllForms}å•)`;
        }
    }


    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    function loadData() {
        const savedData = localStorage.getItem('kanjiQuizDataVer4');
        if (savedData) {
            playerData = JSON.parse(savedData);
            if (typeof playerData.totalRubies === 'undefined') {
                playerData.totalRubies = playerData.totalDiamonds || 0;
                delete playerData.totalDiamonds;
            }
            if (typeof playerData.totalSapphires === 'undefined') {
                playerData.totalSapphires = 0;
            }
            // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®åˆæœŸåŒ–
            if (typeof playerData.totalEmeralds === 'undefined') {
                playerData.totalEmeralds = 0;
            }
            if (typeof playerData.totalTrueDiamonds === 'undefined') {
                playerData.totalTrueDiamonds = 0;
            }
            if (typeof playerData.testClears === 'undefined') {
                playerData.testClears = {};
            }
            if (typeof playerData.exchangeHistory === 'undefined') {
                playerData.exchangeHistory = [];
            }
            if (typeof playerData.reviewQuestions === 'undefined') {
                playerData.reviewQuestions = [];
            }
            if (typeof playerData.comprehensionReviewQuestions === 'undefined') {
                playerData.comprehensionReviewQuestions = [];
            }
        } else {
            playerData = {
                totalRubies: 0,
                totalSapphires: 0,
                totalEmeralds: 0, // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®åˆæœŸåŒ–
                totalTrueDiamonds: 0,
                unlockedStage: gameConfig.initialUnlockedStages,
                stageClears: {},
                testClears: {},
                exchangeHistory: [],
                reviewQuestions: [],
                comprehensionReviewQuestions: []
            };
        }
    }

    function saveData() {
        localStorage.setItem('kanjiQuizDataVer4', JSON.stringify(playerData));
    }

    function exportData() {
        const jsonString = JSON.stringify(playerData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ¼¢å­—ã‚¯ã‚¤ã‚ºã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showCustomAlert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (('totalRubies' in importedData || 'totalDiamonds' in importedData) && 'unlockedStage' in importedData && 'stageClears' in importedData) {
                    showCustomConfirm('ç¾åœ¨ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', () => {
                        if (typeof importedData.totalRubies === 'undefined' && typeof importedData.totalDiamonds !== 'undefined') {
                            importedData.totalRubies = importedData.totalDiamonds;
                            delete importedData.totalDiamonds;
                        }
                        if (typeof importedData.totalSapphires === 'undefined') {
                            importedData.totalSapphires = 0;
                        }
                        // ä¿®æ­£: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãŒãªã„å ´åˆã®å‡¦ç†
                        if (typeof importedData.totalEmeralds === 'undefined') {
                            importedData.totalEmeralds = 0;
                        }
                        if (typeof importedData.totalTrueDiamonds === 'undefined') {
                            importedData.totalTrueDiamonds = 0;
                        }
                        if (typeof importedData.testClears === 'undefined') {
                            importedData.testClears = {};
                        }
                        if (typeof importedData.reviewQuestions === 'undefined') {
                            importedData.reviewQuestions = [];
                        }
                        if (typeof importedData.comprehensionReviewQuestions === 'undefined') {
                            importedData.comprehensionReviewQuestions = [];
                        }
                        playerData = importedData;
                        saveData();
                        showCustomAlert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
                        initApp();
                    }, () => {
                        showCustomAlert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
                    });
                } else {
                    showCustomAlert('ç„¡åŠ¹ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚');
                }
            } catch (error) {
                showCustomAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                importFileInput.value = '';
            }
        };
        reader.readAsText(file);
    }

    function showCustomAlert(message) {
        const customAlert = document.createElement('div');
        customAlert.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000; font-size: 1.5em; text-align: center;
            max-width: 90%; width: 400px;
        `;
        customAlert.innerHTML = `<p>${message}</p>
                                <button style="margin-top: 20px; padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentNode.remove()">OK</button>`;
        document.body.appendChild(customAlert);
    }

    function showCustomConfirm(message, onConfirm, onCancel) {
        const customConfirm = document.createElement('div');
        customConfirm.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000; font-size: 1.5em; text-align: center;
            max-width: 90%; width: 400px;
        `;
        const messageP = document.createElement('p');
        messageP.textContent = message;
        const buttonDiv = document.createElement('div');
        buttonDiv.style.marginTop = '20px';
        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ã¯ã„';
        confirmButton.style.cssText = `padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;`;
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'ã„ã„ãˆ';
        cancelButton.style.cssText = `padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;`;
        buttonDiv.appendChild(confirmButton);
        buttonDiv.appendChild(cancelButton);
        customConfirm.appendChild(messageP);
        customConfirm.appendChild(buttonDiv);
        document.body.appendChild(customConfirm);
        confirmButton.addEventListener('click', () => {
            customConfirm.remove();
            if (onConfirm) onConfirm();
        });
        cancelButton.addEventListener('click', () => {
            customConfirm.remove();
            if (onCancel) onCancel();
        });
    }

    // --- ç”»é¢è¡¨ç¤ºã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---
    function showScreen(screenToShow) {
        document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
        quizContainer.classList.add('hidden');
        resultPage.classList.add('hidden');
        screenToShow.classList.remove('hidden');
    }

    function showMainMenu() {
        showScreen(mainMenuScreen);
        updateDisplays();
        updateOilyouProgressDisplay();
    }

    function showStageSelect() {
        showScreen(stageSelectScreen);
        updateDisplays();
        createStageButtons();
        createReviewStageButtons();
        createComprehensionReviewStageButtons();
        createTestButtons();
        populateReadingComprehensionStageSelectors();
    }

    function showItemExchange() {
        showScreen(itemExchangeScreen);
        updateDisplays();
        renderItemShop();
    }

    function showExchangeHistoryScreen() {
        showScreen(exchangeHistoryScreen);
        renderExchangeHistory();
    }

    function updateDisplays() {
        const totalRubies = playerData.totalRubies;
        const totalSapphires = playerData.totalSapphires;
        const totalEmeralds = playerData.totalEmeralds || 0; // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è¡¨ç¤º
        const totalTrueDiamonds = playerData.totalTrueDiamonds;
        rubyDisplay.textContent = totalRubies;
        sapphireDisplay.textContent = totalSapphires;
        emeraldDisplay.textContent = totalEmeralds; // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è¡¨ç¤ºæ›´æ–°
        trueDiamondDisplay.textContent = totalTrueDiamonds;
        totalQuestionsDisplay.textContent = `å…¨${allQuizData.length}å• / ${gameConfig.totalStages}ã‚¹ãƒ†ãƒ¼ã‚¸`;
        rubyDisplay.className = '';
        if (totalRubies >= 1000) {
            rubyDisplay.classList.add('tier-4');
        } else if (totalRubies >= 500) {
            rubyDisplay.classList.add('tier-3');
        } else if (totalRubies >= 100) {
            rubyDisplay.classList.add('tier-2');
        } else {
            rubyDisplay.classList.add('tier-1');
        }
    }
    
    function populateReadingComprehensionStageSelectors() {
        rcStartStageSelect.innerHTML = '';
        rcEndStageSelect.innerHTML = '';
        const maxStage = playerData.unlockedStage;
        for (let i = 1; i <= maxStage; i++) {
            const startOption = document.createElement('option');
            startOption.value = i;
            startOption.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${i}`;
            rcStartStageSelect.appendChild(startOption);

            const endOption = document.createElement('option');
            endOption.value = i;
            endOption.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${i}`;
            rcEndStageSelect.appendChild(endOption);
        }
        rcEndStageSelect.value = maxStage;
    }


    function createStageButtons() {
        stageSelectionGrid.innerHTML = '';
        for (let i = 1; i <= gameConfig.totalStages; i++) {
            const button = document.createElement('button');
            button.classList.add('stage-button');
            const stageId = `stage-${i}`;
            button.innerHTML = `<span>ã‚¹ãƒ†ãƒ¼ã‚¸ ${i}</span>`;
            button.dataset.stageId = stageId;
            const clearCount = playerData.stageClears[stageId] || 0;
            if (clearCount > 0) {
                const clearMark = document.createElement('span');
                clearMark.classList.add('clear-mark');
                if (clearCount >= 3) {
                    clearMark.textContent = 'â­â­â­';
                } else if (clearCount === 2) {
                    clearMark.textContent = 'â­â­';
                } else {
                    clearMark.textContent = 'â­';
                }
                button.appendChild(clearMark);
            }
            if (i <= playerData.unlockedStage) {
                button.addEventListener('click', () => startQuiz(stageId, false));
            } else {
                button.classList.add('locked');
                button.disabled = true;
            }
            stageSelectionGrid.appendChild(button);
        }
    }

    function createReviewStageButtons() {
        reviewStageSelectionGrid.innerHTML = '';
        const reviewQuestions = playerData.reviewQuestions;
        const requiredQuestions = gameConfig.questionsPerReviewStage;

        if (reviewQuestions.length === 0) {
            const p = document.createElement('p');
            p.textContent = 'å¾©ç¿’ã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            reviewStageSelectionGrid.appendChild(p);
            return;
        }

        const totalFullStages = Math.floor(reviewQuestions.length / requiredQuestions);

        for (let i = 1; i <= totalFullStages; i++) {
            const button = document.createElement('button');
            button.classList.add('stage-button', 'review-stage');
            const stageId = `review-${i}`;
            button.innerHTML = `<span>å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ ${i}</span>`;
            button.dataset.stageId = stageId;
            button.addEventListener('click', () => startQuiz(stageId, false));
            reviewStageSelectionGrid.appendChild(button);
        }

        const remainingQuestions = reviewQuestions.length % requiredQuestions;

        if (remainingQuestions > 0 || totalFullStages === 0) {
            const remainingForNextStage = requiredQuestions - remainingQuestions;
            const p = document.createElement('p');
            
            if (totalFullStages === 0) { 
                p.textContent = `å¾©ç¿’å•é¡ŒãŒ${requiredQuestions}å•ãŸã¾ã‚‹ã¨æŒ‘æˆ¦ã§ãã¾ã™ã€‚(ã‚ã¨${remainingForNextStage}å•)`;
            } else { 
                p.textContent = `æ¬¡ã®å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ã¾ã§ã€ã‚ã¨${remainingForNextStage}å•`;
            }
            reviewStageSelectionGrid.appendChild(p);
        }
    }

    function createComprehensionReviewStageButtons() {
        comprehensionReviewStageSelectionGrid.innerHTML = '';
        const reviewQuestions = playerData.comprehensionReviewQuestions;
        const requiredQuestions = gameConfig.questionsPerReadingComprehensionStage;

        if (reviewQuestions.length === 0) {
            const p = document.createElement('p');
            p.textContent = 'å¾©ç¿’ã™ã‚‹èª­è§£å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            comprehensionReviewStageSelectionGrid.appendChild(p);
            return;
        }

        const totalFullStages = Math.floor(reviewQuestions.length / requiredQuestions);

        for (let i = 1; i <= totalFullStages; i++) {
            const button = document.createElement('button');
            button.classList.add('stage-button', 'review-stage');
            const stageId = `comprehension-review-${i}`;
            button.innerHTML = `<span>èª­è§£å¾©ç¿’ ${i}</span>`;
            button.dataset.stageId = stageId;
            button.addEventListener('click', () => startQuiz(stageId, false));
            comprehensionReviewStageSelectionGrid.appendChild(button);
        }

        const remainingQuestions = reviewQuestions.length % requiredQuestions;

        if (remainingQuestions > 0 || totalFullStages === 0) {
            const remainingForNextStage = requiredQuestions - remainingQuestions;
            const p = document.createElement('p');
            
            if (totalFullStages === 0) { 
                p.textContent = `èª­è§£å¾©ç¿’å•é¡ŒãŒ${requiredQuestions}å•ãŸã¾ã‚‹ã¨æŒ‘æˆ¦ã§ãã¾ã™ã€‚(ã‚ã¨${remainingForNextStage}å•)`;
            } else { 
                p.textContent = `æ¬¡ã®èª­è§£å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ã¾ã§ã€ã‚ã¨${remainingForNextStage}å•`;
            }
            comprehensionReviewStageSelectionGrid.appendChild(p);
        }
    }

    function createTestButtons() {
        testSelectionGrid.innerHTML = '';
        const totalTestBlocks = Math.ceil(gameConfig.totalStages / gameConfig.stagesPerBlock);
        for (let i = 0; i < totalTestBlocks; i++) {
            const startStage = i * gameConfig.stagesPerBlock + 1;
            const endStage = Math.min((i + 1) * gameConfig.stagesPerBlock, gameConfig.totalStages);
            const testId = `test-${startStage}-${endStage}`;
            const button = document.createElement('button');
            button.classList.add('test-button');
            button.innerHTML = `<span>ã‚¹ãƒ†ãƒ¼ã‚¸ ${startStage}ã€œ${endStage} ç¢ºèªãƒ†ã‚¹ãƒˆ</span>`;
            button.dataset.testId = testId;
            const clearCount = playerData.testClears[testId] || 0;
            if (clearCount > 0) {
                const clearMark = document.createElement('span');
                clearMark.classList.add('clear-mark');
                if (clearCount >= 3) {
                    clearMark.textContent = 'â­â­â­';
                } else if (clearCount === 2) {
                    clearMark.textContent = 'â­â­';
                } else {
                    clearMark.textContent = 'â­';
                }
                button.appendChild(clearMark);
            }
            let isTestUnlocked = true;
            for (let j = startStage; j <= endStage; j++) {
                if (!playerData.stageClears[`stage-${j}`] || playerData.stageClears[`stage-${j}`] === 0) {
                    isTestUnlocked = false;
                    break;
                }
            }
            if (isTestUnlocked) {
                button.addEventListener('click', () => startQuiz(testId, false));
            } else {
                button.classList.add('locked');
                button.disabled = true;
            }
            testSelectionGrid.appendChild(button);
        }
    }

    // --- ã‚¢ã‚¤ãƒ†ãƒ äº¤æ› ---
    const exchangeItems = [
        { id: 'toca_life_1min', name: 'ãƒˆãƒƒã‚«ãƒ©ã‚¤ãƒ•ãƒ¯ãƒ¼ãƒ«ãƒ‰ï¼‘åˆ†', cost: 100, currency: 'ruby', available: true },
        { id: 'tosochu_1book', name: 'é€ƒèµ°ä¸­ï¼‘å†Š', cost: 200, currency: 'sapphire', available: true },
        { id: 'foot_massage', name: 'è¶³è£ãƒãƒƒã‚µãƒ¼ã‚¸30ç§’', cost: 10, currency: 'ruby', available: true },
        { id: 'preppy_pack_ruby', name: 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãªãƒ—ãƒ¬ãƒƒãƒ”ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‘ãƒƒã‚¯', cost: 150, currency: 'ruby', available: true },
        { id: 'preppy_pack_sapphire', name: 'å†¬ã®ãƒ›ãƒ¼ãƒ ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ‘ãƒƒã‚¯', cost: 150, currency: 'sapphire', available: true },
        { id: 'uranai_book', name: 'èª•ç”Ÿæ—¥ï¼†åå‰ã†ã‚‰ãªã„ï¼¢ï¼¯ï¼¯ï¼«', cost: 150, currency: 'sapphire', available: true },
        { id: 'diamond_to_ruby', name: 'ãƒ€ã‚¤ãƒ¤ï¼‘å€‹ã‚’<br>ãƒ«ãƒ“ãƒ¼100å€‹ã«äº¤æ›', cost: 1, currency: 'trueDiamond', available: true, exchangeTo: 'ruby', exchangeAmount: 100 },
        { id: 'diamond_to_sapphire', name: 'ãƒ€ã‚¤ãƒ¤ï¼‘å€‹ã‚’<br>ã‚µãƒ•ã‚¡ã‚¤ã‚¢100å€‹ã«äº¤æ›', cost: 1, currency: 'trueDiamond', available: true, exchangeTo: 'sapphire', exchangeAmount: 100 },
    ];

    function renderItemShop() {
        itemExchangeShop.innerHTML = '';
        exchangeItems.forEach(item => {
            const itemCard = document.createElement('div');
            itemCard.classList.add('item-card');

            const itemName = document.createElement('div');
            itemName.classList.add('item-name');
            itemName.innerHTML = item.name;

            const itemCost = document.createElement('div');
            itemCost.classList.add('item-cost');
            if (item.available) {
                let icon = '';
                if (item.currency === 'ruby') {
                    icon = 'ğŸ”´';
                } else if (item.currency === 'sapphire') {
                    icon = 'ğŸ”µ';
                } else if (item.currency === 'trueDiamond') {
                    icon = 'ğŸ’';
                }
                itemCost.innerHTML = `<span class="gem-icon">${icon}</span> ${item.cost}`;
            } else {
                itemCost.textContent = '-';
            }

            const exchangeButton = document.createElement('button');
            exchangeButton.classList.add('exchange-button');
            if (item.available) {
                exchangeButton.textContent = 'äº¤æ›ã™ã‚‹';
                exchangeButton.onclick = () => exchangeItem(item.id);
                
                let playerCurrency = 0;
                if (item.currency === 'ruby') playerCurrency = playerData.totalRubies;
                else if (item.currency === 'sapphire') playerCurrency = playerData.totalSapphires;
                else if (item.currency === 'trueDiamond') playerCurrency = playerData.totalTrueDiamonds;
                
                if (playerCurrency < item.cost) {
                    exchangeButton.disabled = true;
                }
            } else {
                exchangeButton.textContent = 'æº–å‚™ä¸­';
                exchangeButton.disabled = true;
            }

            itemCard.appendChild(itemName);
            itemCard.appendChild(itemCost);
            itemCard.appendChild(exchangeButton);
            itemExchangeShop.appendChild(itemCard);
        });
    }

    function renderExchangeHistory() {
        exchangeHistoryList.innerHTML = '';
        if (playerData.exchangeHistory.length === 0) {
            exchangeHistoryList.innerHTML = '<p>ã¾ã äº¤æ›å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        const ul = document.createElement('ul');
        [...playerData.exchangeHistory].reverse().forEach(record => {
            const li = document.createElement('li');
            li.textContent = record.itemName;
            const dateSpan = document.createElement('span');
            dateSpan.classList.add('history-date');
            dateSpan.textContent = `(${record.date})`;
            li.appendChild(dateSpan);
            ul.appendChild(li);
        });
        exchangeHistoryList.appendChild(ul);
    }

    function exchangeItem(itemId) {
        const item = exchangeItems.find(i => i.id === itemId);
        if (!item) return;

        let playerCurrency = 0;
        let currencyName = '';
        let currencyKey = '';

        if (item.currency === 'ruby') {
            playerCurrency = playerData.totalRubies;
            currencyName = 'ãƒ«ãƒ“ãƒ¼';
            currencyKey = 'totalRubies';
        } else if (item.currency === 'sapphire') {
            playerCurrency = playerData.totalSapphires;
            currencyName = 'ã‚µãƒ•ã‚¡ã‚¤ã‚¢';
            currencyKey = 'totalSapphires';
        } else if (item.currency === 'trueDiamond') {
            playerCurrency = playerData.totalTrueDiamonds;
            currencyName = 'ãƒ€ã‚¤ãƒ¤';
            currencyKey = 'totalTrueDiamonds';
        }

        if (playerCurrency >= item.cost) {
            const confirmMessage = item.exchangeTo ?
                `ã€Œ${item.name.replace(/<br>/g, ' ')}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ` :
                `ã€Œ${item.name}ã€ã‚’${currencyName}${item.cost}å€‹ã¨äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;

            showCustomConfirm(confirmMessage, () => {
                playerData[currencyKey] -= item.cost;

                let successMessage = `ã€Œ${item.name.replace(/<br>/g, ' ')}ã€ã¨äº¤æ›ã—ã¾ã—ãŸï¼`;

                if (item.exchangeTo && item.exchangeAmount) {
                    if (item.exchangeTo === 'ruby') {
                        playerData.totalRubies += item.exchangeAmount;
                        successMessage = `ãƒ€ã‚¤ãƒ¤${item.cost}å€‹ã‚’ãƒ«ãƒ“ãƒ¼${item.exchangeAmount}å€‹ã«äº¤æ›ã—ã¾ã—ãŸï¼`;
                    } else if (item.exchangeTo === 'sapphire') {
                        playerData.totalSapphires += item.exchangeAmount;
                        successMessage = `ãƒ€ã‚¤ãƒ¤${item.cost}å€‹ã‚’ã‚µãƒ•ã‚¡ã‚¤ã‚¢${item.exchangeAmount}å€‹ã«äº¤æ›ã—ã¾ã—ãŸï¼`;
                    }
                }

                playerData.exchangeHistory.push({
                    itemName: item.name.replace(/<br>/g, ' '),
                    date: new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                });
                saveData();
                updateDisplays();
                renderItemShop();
                renderExchangeHistory();
                showCustomAlert(successMessage);
            });
        } else {
            showCustomAlert(`${currencyName}ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚`);
        }
    }

    // --- ã‚¯ã‚¤ã‚ºé€²è¡Œ ---
    function startQuiz(stageId, retry = false) {
        isRetryMode = retry;
        currentStageId = stageId;
        score = 0;
        currentQuestionIndex = 0;
        incorrectQuestions = [];
        quizAttemptResults = [];
        isAnswered = false;

        isOilyouMode = stageId === 'oilyou';
        isTestMode = stageId.startsWith('test-');
        isReviewStage = stageId.startsWith('review-');
        isComprehensionReviewStage = stageId.startsWith('comprehension-review-');
        isReadingComprehensionStage = stageId.startsWith('reading-comprehension') || isComprehensionReviewStage;

        if (isRetryMode) {
            currentQuizData = allQuizData.filter(q => incorrectQuestionsForRetry.includes(q.id));
            if (isOilyouMode) {
                currentQuizData = quizAttemptResults
                    .filter(r => !r.isCorrect)
                    .map(r => ({ ...r.question, oilyouFormId: r.oilyouFormId, oilyouProgressText: r.oilyouProgressText }));
            }
        } else if (isOilyouMode) {
            loadOilyouProgress();
            const clearedStageWordIndexes = new Set();
            for (const testKey in playerData.testClears) {
                if (playerData.testClears[testKey] > 0) {
                    const parts = testKey.split('-');
                    const startStage = parseInt(parts[1]);
                    const endStage = parseInt(parts[2]);
                    for (let stageNum = startStage; stageNum <= endStage; stageNum++) {
                        const sIndex = (stageNum - 1) * gameConfig.questionsPerStage;
                        const eIndex = sIndex + gameConfig.questionsPerStage;
                        for (let i = sIndex; i < eIndex && i < allQuizData.length; i++) {
                            clearedStageWordIndexes.add(i);
                        }
                    }
                }
            }
            const oilyouQuizList = createOilyouRandomQuizList(allQuizData, clearedStageWordIndexes);
            currentQuizData = oilyouQuizList.map(item => ({
                ...item.questionWord,
                oilyouFormId: item.formId,
                oilyouProgressText: item.progressText
            }));
        } else if (isReadingComprehensionStage) {
            let rawQuizData;
             if (isComprehensionReviewStage) {
                const stageNumber = parseInt(stageId.split('-')[2]);
                const startIndex = (stageNumber - 1) * gameConfig.questionsPerReadingComprehensionStage;
                const endIndex = startIndex + gameConfig.questionsPerReadingComprehensionStage;
                const reviewQuestionIds = playerData.comprehensionReviewQuestions.slice(startIndex, endIndex);
                rawQuizData = allQuizData.filter(q => reviewQuestionIds.includes(q.id));
                rawQuizData.sort((a, b) => reviewQuestionIds.indexOf(a.id) - reviewQuestionIds.indexOf(b.id));

             } else {
                const parts = stageId.split('-');
                 if (parts.length > 2) {
                    const startStage = parseInt(parts[2]);
                    const endStage = parseInt(parts[3]);
                    let questionPool = [];
                    for (let i = startStage; i <= endStage; i++) {
                        const startIndex = (i - 1) * gameConfig.questionsPerStage;
                        const endIndex = startIndex + gameConfig.questionsPerStage;
                        if (startIndex < allQuizData.length) {
                            questionPool.push(...allQuizData.slice(startIndex, endIndex));
                        }
                    }
                    rawQuizData = shuffleArray(questionPool).slice(0, gameConfig.questionsPerReadingComprehensionStage);
                 } else {
                    rawQuizData = shuffleArray([...allQuizData]).slice(0, gameConfig.questionsPerReadingComprehensionStage);
                 }
             }

            const reverseMeaningQuestionCount = 2;
            const fillInTheBlankQuestionCount = 2;
            const meaningQuestionCount = 3;
            const shuffledRawData = shuffleArray([...rawQuizData]);
            currentQuizData = shuffledRawData.map((question, index) => {
                if (index < reverseMeaningQuestionCount) {
                    return { ...question, questionType: 'reverse_meaning' };
                } else if (index < reverseMeaningQuestionCount + fillInTheBlankQuestionCount) {
                    return { ...question, questionType: 'fill_in_the_blank' };
                } else if (index < reverseMeaningQuestionCount + fillInTheBlankQuestionCount + meaningQuestionCount) {
                    return { ...question, questionType: 'meaning' };
                } else {
                    return { ...question, questionType: 'sentence' };
                }
            });
            currentQuizData = shuffleArray(currentQuizData);
        } else if (isReviewStage) { 
            const stageNumber = parseInt(stageId.split('-')[1]);
            const startIndex = (stageNumber - 1) * gameConfig.questionsPerReviewStage;
            const endIndex = startIndex + gameConfig.questionsPerReviewStage;
            const reviewQuestionIds = playerData.reviewQuestions.slice(startIndex, endIndex);
            currentQuizData = allQuizData.filter(q => reviewQuestionIds.includes(q.id));
            currentQuizData.sort((a, b) => reviewQuestionIds.indexOf(a.id) - reviewQuestionIds.indexOf(b.id));
        } else if (isTestMode) {
            const [_, startStageStr, endStageStr] = stageId.split('-');
            const startStage = parseInt(startStageStr);
            const endStage = parseInt(endStageStr);
            let relevantQuestionIds = [];
            for (let i = startStage; i <= endStage; i++) {
                const startIndex = (i - 1) * gameConfig.questionsPerStage;
                const endIndex = startIndex + gameConfig.questionsPerStage;
                for (let k = startIndex; k < endIndex; k++) {
                    if (allQuizData[k]) {
                        relevantQuestionIds.push(allQuizData[k].id);
                    }
                }
            }
            currentQuizData = shuffleArray(allQuizData.filter(q => relevantQuestionIds.includes(q.id))).slice(0, gameConfig.questionsPerTest);
            isRetryMode = false;
        } else { // é€šå¸¸ã‚¹ãƒ†ãƒ¼ã‚¸
            const stageNumber = parseInt(stageId.split('-')[1]);
            const startIndex = (stageNumber - 1) * gameConfig.questionsPerStage;
            const endIndex = startIndex + gameConfig.questionsPerStage;
            currentQuizData = allQuizData.slice(startIndex, endIndex);
        }

        if (currentQuizData.length === 0 && isOilyouMode) {
            showCustomAlert('ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å…¨ã¦ã®å˜èªã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸï¼');
            return;
        }

        mainMenuScreen.classList.add('hidden');
        stageSelectScreen.classList.add('hidden');
        itemExchangeScreen.classList.add('hidden');
        quizContainer.classList.remove('hidden');
        resultPage.classList.add('hidden');
        loadingSpinner.style.display = 'block';
        quizContent.classList.add('hidden');

        setTimeout(() => {
            loadingSpinner.style.display = 'none';
            quizContent.classList.remove('hidden');
            loadQuestion();
        }, 500);
    }
    
    function loadQuestion() {
        quizContainer.removeEventListener('click', goToNextQuestion);
        if (currentQuestionIndex < currentQuizData.length) {
            isAnswered = false;
            feedbackElem.textContent = '';
            feedbackElem.className = '';
            wordMeaningElem.innerHTML = '';
            choicesElem.innerHTML = '';
            comprehensionInstructionElem.innerHTML = '';
            comprehensionWordElem.innerHTML = '';
            choicesElem.className = 'choices-grid';

            if (isOilyouMode) {
                const question = currentQuizData[currentQuestionIndex];
                questionNumberElem.textContent = `èªå½™ç‹ã¸ã®é“ (${question.oilyouProgressText})  ç¬¬ ${currentQuestionIndex + 1} å• / ${currentQuizData.length} å•`;
                switch (question.oilyouFormId) {
                    case 1: loadNormalQuizPhase(); break;
                    case 2: loadFillInTheBlankQuestion(); break;
                    case 3: loadMeaningChoiceQuestion(); break;
                    case 4: loadReverseMeaningQuestion(); break;
                    case 5: loadSentenceChoiceQuestion(); break;
                    default: loadNormalQuizPhase(); break;
                }
            } else if (isReadingComprehensionStage) {
                const question = currentQuizData[currentQuestionIndex];
                if (question.questionType === 'fill_in_the_blank') {
                    loadFillInTheBlankQuestion();
                } else if (question.questionType === 'meaning') {
                    loadMeaningChoiceQuestion();
                } else if (question.questionType === 'reverse_meaning') {
                    loadReverseMeaningQuestion();
                } else {
                    loadSentenceChoiceQuestion();
                }
            } else {
                loadNormalQuizPhase();
            }
        } else {
            showResults();
        }
    }

    function loadNormalQuizPhase() {
        const question = currentQuizData[currentQuestionIndex];
        if (!isOilyouMode) {
            questionNumberElem.textContent = `ç¬¬ ${currentQuestionIndex + 1} å• / ${currentQuizData.length} å•`;
        }
        sentenceElem.innerHTML = '';
        comprehensionInstructionElem.innerHTML = '';
        comprehensionWordElem.innerHTML = '';
        
        let sentenceToDisplay = '';
        if (isRetryMode && question.sentence2) {
            sentenceToDisplay = question.sentence2;
        } else {
            if (question.sentence2 && Math.random() < 0.5) {
                sentenceToDisplay = question.sentence2;
            } else {
                sentenceToDisplay = question.sentence;
            }
        }
        sentenceElem.innerHTML = sentenceToDisplay;

        const shuffledChoices = shuffleArray([...question.choices]);
        shuffledChoices.forEach(choice => {
            const button = document.createElement('div');
            button.classList.add('choice-button');
            button.textContent = choice;
            button.onclick = (event) => {
                event.stopPropagation();
                selectAnswer(choice, question, button);
            };
            choicesElem.appendChild(button);
        });
    }

    function loadFillInTheBlankQuestion() {
        const question = currentQuizData[currentQuestionIndex];
        if (!isOilyouMode) {
            questionNumberElem.textContent = `ç¬¬ ${currentQuestionIndex + 1} å• / ${currentQuizData.length} å•`;
        }
        comprehensionInstructionElem.innerHTML = "ç©ºæ¬„ã«ã‚ã¦ã¯ã¾ã‚‹èªå¥ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
        comprehensionWordElem.innerHTML = "";
        
        let sentenceToDisplay = '';
        if (question.sentence2 && Math.random() < 0.5) {
            sentenceToDisplay = question.sentence2;
        } else {
            sentenceToDisplay = question.sentence;
        }
        sentenceElem.innerHTML = sentenceToDisplay.replace(`<u>${question.word_to_read}</u>`, 'ï¼¿ï¼¿ï¼¿').replace(question.word_to_read, 'ï¼¿ï¼¿ï¼¿');

        choicesElem.classList.add('comprehension', 'compact-choices');

        const correctChoice = { text: question.word_to_read, reading: question.correct_reading, isCorrect: true };
        const incorrectChoices = [];
        
        const otherQuestions = allQuizData.filter(q => q.id !== question.id && q.word_to_read !== question.word_to_read);
        const shuffledOtherQuestions = shuffleArray(otherQuestions);

        for (let i = 0; i < 4; i++) {
            if (shuffledOtherQuestions[i]) {
                const q = shuffledOtherQuestions[i];
                incorrectChoices.push({ 
                    text: q.word_to_read,
                    reading: q.correct_reading, 
                    isCorrect: false 
                });
            }
        }

        const allChoices = shuffleArray([correctChoice, ...incorrectChoices]);

        allChoices.forEach(choiceData => {
            const button = document.createElement('div');
            button.classList.add('choice-button');
            button.textContent = `${choiceData.text}ï¼ˆ${choiceData.reading}ï¼‰`;
            button.dataset.isCorrect = choiceData.isCorrect;
            button.onclick = (event) => {
                event.stopPropagation();
                selectAnswer(choiceData, question, button);
            };
            choicesElem.appendChild(button);
        });
    }

    function loadReverseMeaningQuestion() {
        const question = currentQuizData[currentQuestionIndex];
        if (!isOilyouMode) {
            questionNumberElem.textContent = `ç¬¬ ${currentQuestionIndex + 1} å• / ${currentQuizData.length} å•`;
        }
        comprehensionInstructionElem.innerHTML = "ã“ã®æ„å‘³ã‚’æŒã¤èªå¥ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
        comprehensionWordElem.innerHTML = `ã€Œ${question.meaning}ã€`;
        sentenceElem.innerHTML = "";
        choicesElem.classList.add('comprehension', 'compact-choices');

        const correctChoice = { text: question.word_to_read, reading: question.correct_reading, isCorrect: true };
        const incorrectChoices = [];
        
        const otherQuestions = allQuizData.filter(q => q.id !== question.id && q.word_to_read !== question.word_to_read);
        const shuffledOtherQuestions = shuffleArray(otherQuestions);

        for (let i = 0; i < 4; i++) {
            if (shuffledOtherQuestions[i]) {
                const q = shuffledOtherQuestions[i];
                incorrectChoices.push({ 
                    text: q.word_to_read,
                    reading: q.correct_reading, 
                    isCorrect: false 
                });
            }
        }

        const allChoices = shuffleArray([correctChoice, ...incorrectChoices]);

        allChoices.forEach(choiceData => {
            const button = document.createElement('div');
            button.classList.add('choice-button');
            button.textContent = `${choiceData.text}ï¼ˆ${choiceData.reading}ï¼‰`;
            button.dataset.isCorrect = choiceData.isCorrect;
            button.onclick = (event) => {
                event.stopPropagation();
                selectAnswer(choiceData, question, button);
            };
            choicesElem.appendChild(button);
        });
    }

    function loadMeaningChoiceQuestion() {
        const question = currentQuizData[currentQuestionIndex];
        if (!isOilyouMode) {
            questionNumberElem.textContent = `ç¬¬ ${currentQuestionIndex + 1} å• / ${currentQuizData.length} å•`;
        }
        comprehensionInstructionElem.innerHTML = "æ­£ã—ã„æ„å‘³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
        comprehensionWordElem.innerHTML = `ã€Œ${question.word_to_read}ï¼ˆ${question.correct_reading}ï¼‰ã€`;
        sentenceElem.innerHTML = "";
        choicesElem.classList.add('comprehension');

        const correctChoice = { meaning: question.meaning, isCorrect: true };
        const incorrectChoices = [];
        
        const otherMeanings = new Set(allQuizData.filter(q => q.id !== question.id).map(q => q.meaning));
        otherMeanings.delete(question.meaning);
        const shuffledOtherMeanings = shuffleArray(Array.from(otherMeanings));

        for (let i = 0; i < 4; i++) {
            if (shuffledOtherMeanings[i]) {
                incorrectChoices.push({ 
                    meaning: shuffledOtherMeanings[i], 
                    isCorrect: false 
                });
            }
        }

        const allChoices = shuffleArray([correctChoice, ...incorrectChoices]);

        allChoices.forEach(choiceData => {
            const button = document.createElement('div');
            button.classList.add('choice-button');
            button.textContent = choiceData.meaning;
            button.dataset.isCorrect = choiceData.isCorrect;
            button.onclick = (event) => {
                event.stopPropagation();
                selectAnswer(choiceData, question, button);
            };
            choicesElem.appendChild(button);
        });
    }

    function loadSentenceChoiceQuestion() {
        const question = currentQuizData[currentQuestionIndex];
        if (!isOilyouMode) {
            questionNumberElem.textContent = `ç¬¬ ${currentQuestionIndex + 1} å• / ${currentQuizData.length} å•`;
        }
        comprehensionInstructionElem.innerHTML = "ã“ã®èªå¥ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹æ­£ã—ã„ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
        comprehensionWordElem.innerHTML = `ã€Œ${question.word_to_read}ï¼ˆ${question.correct_reading}ï¼‰ã€`;
        sentenceElem.innerHTML = "";
        choicesElem.classList.add('comprehension');

        const correctChoice = { sentence: question.sentence, word: question.word_to_read, isCorrect: true };
        const incorrectChoices = [];
        const otherQuestions = allQuizData.filter(q => q.id !== question.id);
        const shuffledOthers = shuffleArray(otherQuestions);

        for (let i = 0; i < 4; i++) {
            incorrectChoices.push({ 
                sentence: shuffledOthers[i].sentence, 
                word: shuffledOthers[i].word_to_read, 
                isCorrect: false 
            });
        }

        const allChoices = shuffleArray([correctChoice, ...incorrectChoices]);

        allChoices.forEach(choiceData => {
            const button = document.createElement('div');
            button.classList.add('choice-button');
            button.innerHTML = choiceData.sentence.replace(new RegExp(choiceData.word, 'g'), 'ï¼¿ï¼¿ï¼¿');
            button.dataset.isCorrect = choiceData.isCorrect;
            button.onclick = (event) => {
                event.stopPropagation();
                selectAnswer(choiceData, question, button);
            };
            choicesElem.appendChild(button);
        });
    }

    function selectAnswer(selectedData, question, selectedButton) {
        if (isAnswered) return;
        isAnswered = true;

        if (isReadingComprehensionStage || (isOilyouMode && question.oilyouFormId > 1)) {
            handleComprehensionAnswer(selectedData, question, selectedButton);
        } else {
            handleNormalAnswer(selectedData, question, selectedButton);
        }
    }

    function handleNormalAnswer(selectedChoice, question, selectedButton) {
        const allChoiceButtons = document.querySelectorAll('.choice-button');
        allChoiceButtons.forEach(button => button.onclick = null);
        const isCorrect = (selectedChoice === question.correct_reading);
        
        const resultLog = {
            question: question,
            userAnswer: selectedChoice,
            isCorrect: isCorrect,
            sentenceDisplayed: sentenceElem.innerHTML
        };
        if (isOilyouMode) {
            resultLog.oilyouFormId = question.oilyouFormId;
            resultLog.oilyouProgressText = question.oilyouProgressText;
        }
        quizAttemptResults.push(resultLog);

        if (isCorrect) {
            feedbackElem.textContent = 'æ­£è§£ï¼';
            feedbackElem.classList.add('correct');
            score++;
            selectedButton.classList.add('correct');
            if (isOilyouMode && !isRetryMode) {
                const wordIndex = question.id;
                const formId = question.oilyouFormId;
                const progress = oilyouProgressData[String(wordIndex)];
                const isFirstTimeCorrect = !progress || !progress[`form${formId}`];
                updateOilyouProgress(wordIndex, formId, isFirstTimeCorrect);
            }
        } else {
            feedbackElem.textContent = 'ä¸æ­£è§£â€¦';
            feedbackElem.classList.add('incorrect');
            selectedButton.classList.add('incorrect');
            incorrectQuestions.push(question.id);
            allChoiceButtons.forEach(button => {
                if (button.textContent === question.correct_reading) {
                    button.classList.add('correct');
                }
            });
        }
        
        let textToSpeak = '';
        if (isRetryMode && question.sentence2) {
            textToSpeak = question.sentence2.replace(/<u>|<\/u>/g, '');
        } else {
            textToSpeak = question.correct_reading;
        }
        speakText(textToSpeak);

        wordMeaningElem.innerHTML = `<span class="word-display">${question.word_to_read}ï¼ˆ${question.correct_reading}ï¼‰</span><span class="meaning-display">${question.meaning}</span>`;
        setTimeout(() => {
            quizContainer.addEventListener('click', goToNextQuestion);
        }, 100);
    }
    
    function handleComprehensionAnswer(selectedData, question, selectedButton) {
        const allChoiceButtons = document.querySelectorAll('.choice-button');
        allChoiceButtons.forEach(button => button.onclick = null);

        const isCorrect = selectedButton.dataset.isCorrect === 'true';
        
        let userAnswerText = '';
        if (question.questionType === 'meaning' || (isOilyouMode && question.oilyouFormId === 3)) {
            userAnswerText = selectedData.meaning;
        } else if (question.questionType === 'sentence' || (isOilyouMode && question.oilyouFormId === 5)) {
            userAnswerText = selectedData.sentence;
        } else if (question.questionType === 'fill_in_the_blank' || (isOilyouMode && question.oilyouFormId === 2) || question.questionType === 'reverse_meaning' || (isOilyouMode && question.oilyouFormId === 4)) {
            userAnswerText = `${selectedData.text}ï¼ˆ${selectedData.reading}ï¼‰`;
        }

        const resultLog = {
            question: question,
            userAnswer: userAnswerText,
            isCorrect: isCorrect,
            questionType: question.questionType,
            sentenceDisplayed: sentenceElem.innerHTML
        };
        if (isOilyouMode) {
            resultLog.oilyouFormId = question.oilyouFormId;
            resultLog.oilyouProgressText = question.oilyouProgressText;
        }
        quizAttemptResults.push(resultLog);

        if (isCorrect) {
            feedbackElem.textContent = 'æ­£è§£ï¼';
            feedbackElem.classList.add('correct');
            selectedButton.classList.add('correct');
            score++;
            if (isOilyouMode && !isRetryMode) {
                const wordIndex = question.id;
                const formId = question.oilyouFormId;
                const progress = oilyouProgressData[String(wordIndex)];
                const isFirstTimeCorrect = !progress || !progress[`form${formId}`];
                updateOilyouProgress(wordIndex, formId, isFirstTimeCorrect);
            }
        } else {
            feedbackElem.textContent = 'ä¸æ­£è§£â€¦';
            feedbackElem.classList.add('incorrect');
            selectedButton.classList.add('incorrect');
            if (!incorrectQuestions.includes(question.id)) {
                incorrectQuestions.push(question.id);
            }
            allChoiceButtons.forEach(button => {
                if (button.dataset.isCorrect === 'true') {
                    button.classList.add('correct');
                }
            });
        }
        speakText(question.correct_reading);
        wordMeaningElem.innerHTML = `<span class="word-display">${question.word_to_read}ï¼ˆ${question.correct_reading}ï¼‰</span><span class="meaning-display">${question.meaning}</span>`;
        setTimeout(() => quizContainer.addEventListener('click', goToNextQuestion), 100);
    }

    function speakText(text) {
        if ('speechSynthesis' in window) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
        } else {
            console.warn('SpeechSynthesis API is not supported in this browser.');
        }
    }

    function goToNextQuestion() {
        if (!isAnswered) return;
        quizContainer.removeEventListener('click', goToNextQuestion);
        currentQuestionIndex++;
        loadQuestion();
    }
    
    // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ç²å¾—ã®å…±é€šé–¢æ•°
    function tryDropEmerald() {
        if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡
            const amount = 1;
            playerData.totalEmeralds = (playerData.totalEmeralds || 0) + amount;
            showGemAnimation(amount, 'emerald');
            return true;
        }
        return false;
    }

    function showResults() {
        quizContainer.classList.add('hidden');
        resultPage.classList.remove('hidden');
        nextStageButton.classList.add('hidden');
        resultTitle.textContent = 'çµæœç™ºè¡¨ï¼';

        let isPerfect = incorrectQuestions.length === 0;
        let earnedAmount = 0;
        let gemType = '';
        incorrectQuestionsForRetry = [...new Set(incorrectQuestions)];

        if (isOilyouMode) {
            const total = currentQuizData.length;
            const correct = score;
            let message = `<p>æ­£è§£æ•°: ${correct} / ${total}</p>`;
            
            resultTitle.textContent = isRetryMode ? 'å†æŒ‘æˆ¦ã®çµæœ' : 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœ';

            if (total > 0) {
                const perfect = (correct === total);
                if (perfect) {
                    const gainedAmount = 15;
                    playerData.totalSapphires += gainedAmount;
                    showGemAnimation(gainedAmount, 'sapphire');
                    message += isRetryMode ? `ğŸ‰ è¦‹äº‹ã‚¯ãƒªã‚¢ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${gainedAmount}å€‹ç²å¾—ã—ã¾ã—ãŸï¼ ğŸ‰` : `ğŸ‰ å…¨å•æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${gainedAmount}å€‹ç²å¾—ã—ã¾ã—ãŸï¼ ğŸ‰`;
                    
                    // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ç²å¾—åˆ¤å®š
                    if (tryDropEmerald()) {
                        message += `<br><strong>âœ¨ ã™ã”ã„ï¼ãƒ¬ã‚¢å®çŸ³ã®ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚’1å€‹ç™ºè¦‹ã—ãŸã‚ˆï¼ âœ¨</strong>`;
                    }
                } else {
                    message += `ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼é–“é•ãˆãŸå•é¡Œã¯ã¾ãŸå‡ºé¡Œã•ã‚Œã¾ã™ã€‚`;
                }
            } else {
                message += `ğŸ‰ å…¨ã¦ã®å˜èªã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ãªãŸã¯èªå½™ç‹ã§ã™ï¼ ğŸ‰`;
            }

            scoreElem.innerHTML = message;
            retryButton.classList.toggle('hidden', incorrectQuestionsForRetry.length === 0);
            allRetryButton.textContent = 'ã‚‚ã†ä¸€åº¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°';
            backToStageSelectButton.textContent = 'ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹';
        } else if (isReadingComprehensionStage) {
            isPerfect = incorrectQuestionsForRetry.length === 0;

            if (isComprehensionReviewStage) {
                gemType = 'sapphire';
                if (isPerfect) {
                    earnedAmount = 20;
                    playerData.totalSapphires += earnedAmount;
                    showGemAnimation(earnedAmount, gemType);
                    let message = isRetryMode ? `ãŠã‚ã§ã¨ã†ï¼å†æŒ‘æˆ¦ã§å…¨å•æ­£è§£ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${earnedAmount}å€‹ç²å¾—ï¼` : `ãŠã‚ã§ã¨ã†ï¼èª­è§£å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${earnedAmount}å€‹ç²å¾—ï¼`;
                    showCustomAlert(message);
                } else {
                    const message = isRetryMode ? 'å†æŒ‘æˆ¦ãŒçµ‚ã‚ã£ãŸã‚ˆï¼' : 'èª­è§£å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ãŒçµ‚ã‚ã£ãŸã‚ˆï¼é–“é•ãˆãŸå•é¡Œã¯ã‚‚ã†ä¸€åº¦å¾©ç¿’ã—ã‚ˆã†ï¼';
                    showCustomAlert(message);
                }

                if (!isRetryMode) {
                    const correctFirstTryIds = quizAttemptResults.filter(r => r.isCorrect).map(r => r.question.id);
                    playerData.comprehensionReviewQuestions = playerData.comprehensionReviewQuestions.filter(id => !correctFirstTryIds.includes(id));
                }
            } else {
                gemType = 'sapphire';
                if (isPerfect) {
                    earnedAmount = 10;
                    playerData.totalSapphires += earnedAmount;
                    showGemAnimation(earnedAmount, gemType);
                    let message = isRetryMode ? `ãŠã‚ã§ã¨ã†ï¼å†æŒ‘æˆ¦ã§å…¨å•æ­£è§£ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${earnedAmount}å€‹ç²å¾—ï¼` : `ãŠã‚ã§ã¨ã†ï¼å…¨å•æ­£è§£ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${earnedAmount}å€‹ç²å¾—ï¼`;
                    
                    // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ç²å¾—åˆ¤å®š
                    if (tryDropEmerald()) {
                        message += `\nâœ¨ ã™ã”ã„ï¼ãƒ¬ã‚¢å®çŸ³ã®ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚’1å€‹ç™ºè¦‹ã—ãŸã‚ˆï¼ âœ¨`;
                    }
                    showCustomAlert(message);
                } else {
                    showCustomAlert('èª­è§£ã‚¹ãƒ†ãƒ¼ã‚¸ãŒçµ‚ã‚ã£ãŸã‚ˆï¼');
                }
                
                if (!isRetryMode) {
                    incorrectQuestions.forEach(qId => {
                        if (!playerData.comprehensionReviewQuestions.includes(qId)) {
                            playerData.comprehensionReviewQuestions.push(qId);
                        }
                    });
                }
            }
            retryButton.classList.toggle('hidden', incorrectQuestionsForRetry.length === 0);
        
        } else if (isReviewStage) {
            if (isPerfect) {
                earnedAmount = 15;
                gemType = 'sapphire';
                playerData.totalSapphires += earnedAmount;
                showGemAnimation(earnedAmount, gemType);
                const message = isRetryMode ? `ãŠã‚ã§ã¨ã†ï¼å†æŒ‘æˆ¦ã§å…¨å•æ­£è§£ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${earnedAmount}å€‹ç²å¾—ï¼` : `ãŠã‚ã§ã¨ã†ï¼å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ã‚µãƒ•ã‚¡ã‚¤ã‚¢ã‚’${earnedAmount}å€‹ç²å¾—ï¼`;
                showCustomAlert(message);
            } else { 
                const message = isRetryMode ? 'å†æŒ‘æˆ¦ãŒçµ‚ã‚ã£ãŸã‚ˆï¼' : 'å¾©ç¿’ã‚¹ãƒ†ãƒ¼ã‚¸ãŒçµ‚ã‚ã£ãŸã‚ˆï¼é–“é•ãˆãŸå•é¡Œã¯ã‚‚ã†ä¸€åº¦å¾©ç¿’ã—ã‚ˆã†ï¼';
                showCustomAlert(message);
            }

            if (!isRetryMode) {
                const correctFirstTryIds = quizAttemptResults.filter(r => r.isCorrect).map(r => r.question.id);
                const incorrectFirstTryIds = incorrectQuestions;
                let updatedReviewQuestions = playerData.reviewQuestions.filter(id => !correctFirstTryIds.includes(id));
                updatedReviewQuestions = updatedReviewQuestions.filter(id => !incorrectFirstTryIds.includes(id));
                updatedReviewQuestions.push(...incorrectFirstTryIds);
                playerData.reviewQuestions = updatedReviewQuestions;
            }
            retryButton.classList.toggle('hidden', incorrectQuestionsForRetry.length === 0);

        } else {
            if (!isRetryMode) {
                incorrectQuestions.forEach(qId => {
                    if (!playerData.reviewQuestions.includes(qId)) {
                        playerData.reviewQuestions.push(qId);
                    }
                });
            }

            if (isTestMode) {
                gemType = 'trueDiamond';
                if (isPerfect) {
                    earnedAmount = 1;
                    const previousClears = playerData.testClears[currentStageId] || 0;
                    playerData.testClears[currentStageId] = previousClears + 1;
                    let message = '';
                    if (previousClears === 0) { 
                        playerData.totalTrueDiamonds += earnedAmount;
                        showGemAnimation(earnedAmount, gemType);
                        message = `ãŠã‚ã§ã¨ã†ï¼ç¢ºèªãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ãŸã‚ˆï¼ãƒ€ã‚¤ãƒ¤ã‚’${earnedAmount}å€‹ç²å¾—ï¼`;
                    } else {
                        message = 'ãŠã‚ã§ã¨ã†ï¼ç¢ºèªãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ãŸã‚ˆï¼';
                    }
                    
                    // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ç²å¾—åˆ¤å®š
                    if (tryDropEmerald()) {
                        message += `\nâœ¨ ã™ã”ã„ï¼ãƒ¬ã‚¢å®çŸ³ã®ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚’1å€‹ç™ºè¦‹ã—ãŸã‚ˆï¼ âœ¨`;
                    }
                    showCustomAlert(message);
                    
                    checkAndUnlockNextStageBlock(currentStageId);
                } else {
                    showCustomAlert('æ®‹å¿µï¼ç¢ºèªãƒ†ã‚¹ãƒˆã¯å…¨å•æ­£è§£ãŒå¿…è¦ã ã‚ˆã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã­ï¼');
                }
                retryButton.classList.add('hidden');
            } else { // é€šå¸¸ã‚¹ãƒ†ãƒ¼ã‚¸
                gemType = 'ruby';
                if (!isRetryMode && !isPerfect) {
                    showCustomAlert('ã‚¹ãƒ†ãƒ¼ã‚¸ãŒçµ‚ã‚ã£ãŸã‚ˆï¼é–“é•ãˆãŸå•é¡Œã«å†æŒ‘æˆ¦ã—ã¦ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ãƒ«ãƒ“ãƒ¼ãŒã‚‚ã‚‰ãˆã‚‹ã‚ˆï¼');
                } else {
                    if (isPerfect) {
                        const originalClears = playerData.stageClears[currentStageId] || 0;
                        if (isRetryMode && originalClears > 0) {
                            playerData.stageClears[currentStageId] = originalClears - 1;
                        }
                        earnedAmount = calculateRubies(currentStageId);
                        if (isRetryMode && originalClears > 0) {
                            playerData.stageClears[currentStageId] = originalClears;
                        }

                        let message = '';
                        if (earnedAmount > 0) {
                            playerData.totalRubies += earnedAmount;
                            showGemAnimation(earnedAmount, gemType);
                            message = isRetryMode ? `ãŠã‚ã§ã¨ã†ï¼å†æŒ‘æˆ¦ã§å…¨å•æ­£è§£ï¼ãƒ«ãƒ“ãƒ¼ã‚’${earnedAmount}å€‹ç²å¾—ï¼` : `ãŠã‚ã§ã¨ã†ï¼ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãƒ«ãƒ“ãƒ¼ã‚’${earnedAmount}å€‹ç²å¾—ï¼`;
                        } else {
                            message = isRetryMode ? 'ãŠã‚ã§ã¨ã†ï¼å†æŒ‘æˆ¦ã§å…¨å•æ­£è§£ã—ãŸã‚ˆï¼' : 'ãŠã‚ã§ã¨ã†ï¼ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼';
                        }

                        // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ç²å¾—åˆ¤å®š
                        if (tryDropEmerald()) {
                            message += `\nâœ¨ ã™ã”ã„ï¼ãƒ¬ã‚¢å®çŸ³ã®ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚’1å€‹ç™ºè¦‹ã—ãŸã‚ˆï¼ âœ¨`;
                        }
                        showCustomAlert(message);

                        const currentStageNumber = parseInt(currentStageId.split('-')[1]);
                        const nextStageNumber = currentStageNumber + 1;
                        if (nextStageNumber <= playerData.unlockedStage && nextStageNumber <= gameConfig.totalStages) {
                            nextStageButton.classList.remove('hidden');
                            nextStageButton.onclick = () => startQuiz(`stage-${nextStageNumber}`, false);
                        }
                    } else {
                        showCustomAlert('å†æŒ‘æˆ¦ãŒçµ‚ã‚ã£ãŸã‚ˆï¼');
                    }
                }

                if (!isRetryMode) {
                    playerData.stageClears[currentStageId] = (playerData.stageClears[currentStageId] || 0) + 1;
                }

                checkAndUnlockStages();
                retryButton.classList.toggle('hidden', incorrectQuestionsForRetry.length === 0);
            }
        }
        
        saveData();
        updateDisplays();
        if (!isOilyouMode) {
            scoreElem.textContent = `${score} / ${currentQuizData.length} å•æ­£è§£ï¼`;
        }
        
        quizResultsList.innerHTML = '<h3>ã‚¯ã‚¤ã‚ºçµæœä¸€è¦§:</h3>';
        const ul = document.createElement('ul');

        if (isReadingComprehensionStage || isOilyouMode) {
            quizAttemptResults.forEach((result, index) => {
                const question = result.question;
                const resultText = result.isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£';
                const resultClass = result.isCorrect ? 'result-correct' : 'result-incorrect';
                const li = document.createElement('li');
                
                const questionType = isOilyouMode ? result.oilyouFormId : result.questionType;

                if (questionType === 2 || questionType === 'fill_in_the_blank') {
                    li.innerHTML = `
                        <p><strong>ç¬¬${index + 1}å•:</strong> ç©ºæ¬„ã«ã‚ã¦ã¯ã¾ã‚‹èªå¥ã‚’é¸ã¶å•é¡Œ</p>
                        <p>${result.sentenceDisplayed}</p>
                        <p>ã‚ãªãŸã®å›ç­”: <span class="${resultClass}">${result.userAnswer}</span></p>
                        <p class="correct-answer-display">æ­£è§£: ${question.word_to_read}ï¼ˆ${question.correct_reading}ï¼‰</p>
                        <p class="${resultClass}">${resultText}</p>
                    `;
                } else if (questionType === 4 || questionType === 'reverse_meaning') {
                     li.innerHTML = `
                        <p><strong>ç¬¬${index + 1}å•:</strong> æ„å‘³ã‹ã‚‰èªå¥ã‚’é¸ã¶å•é¡Œ</p>
                        <p>å•é¡Œ: ã€Œ${question.meaning}ã€</p>
                        <p>ã‚ãªãŸã®å›ç­”: <span class="${resultClass}">${result.userAnswer}</span></p>
                        <p class="correct-answer-display">æ­£è§£: ${question.word_to_read}ï¼ˆ${question.correct_reading}ï¼‰</p>
                        <p class="${resultClass}">${resultText}</p>
                    `;
                } else if (questionType === 3 || questionType === 'meaning') {
                    li.innerHTML = `
                        <p><strong>ç¬¬${index + 1}å•:</strong> ã€Œ${question.word_to_read}ã€ã®æ­£ã—ã„æ„å‘³ã‚’é¸ã¶å•é¡Œ</p>
                        <p>ã‚ãªãŸã®å›ç­”: <span class="${resultClass}">${result.userAnswer}</span></p>
                        <p class="correct-answer-display">æ­£è§£: ${question.meaning}</p>
                        <p class="${resultClass}">${resultText}</p>
                    `;
                } else if (questionType === 5 || questionType === 'sentence') {
                    li.innerHTML = `
                        <p><strong>ç¬¬${index + 1}å•:</strong> ã€Œ${question.word_to_read}ã€ãŒå…¥ã‚‹æ­£ã—ã„ä¾‹æ–‡ã‚’é¸ã¶å•é¡Œ</p>
                        <p class="${resultClass}">${resultText}</p>
                        <p class="correct-answer-display">æ­£è§£: ${question.sentence}</p>
                    `;
                } else { 
                     li.innerHTML = `
                        <p><strong>ç¬¬${index + 1}å•:</strong> ${result.sentenceDisplayed.replace(/<u>(.*?)<\/u>/, '<span><u>$1</u></span>')}</p>
                        <p>ã‚ãªãŸã®å›ç­”: <span class="${resultClass}">${result.userAnswer}</span></p>
                        <p class="correct-answer-display">æ­£è§£: ${question.correct_reading}</p>
                        <p class="${resultClass}">${resultText}</p>
                    `;
                }
                ul.appendChild(li);
            });
        } else {
            quizAttemptResults.forEach((result, index) => {
                const question = result.question;
                const sentenceToDisplay = result.sentenceDisplayed;
                const resultText = result.isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£';
                const resultClass = result.isCorrect ? 'result-correct' : 'result-incorrect';
                const li = document.createElement('li'); 
                li.innerHTML = `
                    <p><strong>ç¬¬${index + 1}å•:</strong> ${sentenceToDisplay.replace(/<u>(.*?)<\/u>/, '<span><u>$1</u></span>')}</p>
                    <p>ã‚ãªãŸã®å›ç­”: <span class="${resultClass}">${result.userAnswer}</span></p>
                    <p class="correct-answer-display">æ­£è§£: ${question.correct_reading}</p>
                    <p class="${resultClass}">${resultText}</p>
                `;
                ul.appendChild(li);
            });
        }
        quizResultsList.appendChild(ul);

        if (incorrectQuestionsForRetry.length > 0 && !isTestMode) {
            retryButton.classList.remove('hidden');
        } else {
            retryButton.classList.add('hidden');
        }
    }

    function calculateRubies(stageId) {
        const clearCount = playerData.stageClears[stageId] || 0;
        if (clearCount === 0) return 10;
        if (clearCount === 1) return 5;
        if (clearCount === 2) return 1;
        return 0;
    }

    function showGemAnimation(amount, type) {
        const gainText = document.createElement('div');
        gainText.id = 'gem-gain-text';
        let gemName = '';
        let gemChar = '';
        if (type === 'ruby') {
            gemName = 'ãƒ«ãƒ“ãƒ¼';
            gemChar = 'ğŸ”´';
        } else if (type === 'sapphire') {
            gemName = 'ã‚µãƒ•ã‚¡ã‚¤ã‚¢';
            gemChar = 'ğŸ”µ';
        } else if (type === 'emerald') { // ä¿®æ­£: ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            gemName = 'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰';
            gemChar = 'ğŸŸ¢';
        } else if (type === 'trueDiamond') {
            gemName = 'ãƒ€ã‚¤ãƒ¤';
            gemChar = 'ğŸ’';
        }
        gainText.textContent = `${amount}${gemName} ç²å¾—ï¼`;
        gainText.classList.add(type);
        gemAnimationContainer.appendChild(gainText);
        for (let i = 0; i < 15; i++) {
            const burst = document.createElement('div');
            burst.classList.add('gem-burst', type);
            burst.textContent = gemChar;
            burst.style.left = `${Math.random() * 100}vw`;
            burst.style.top = `${Math.random() * 100}vh`;
            burst.style.animationDelay = `${Math.random() * 0.2}s`;
            gemAnimationContainer.appendChild(burst);
        }
        setTimeout(() => {
            gemAnimationContainer.innerHTML = '';
        }, 2000);
    }

    function checkAndUnlockStages() {
        const lastUnlockedStage = playerData.unlockedStage;
        if (lastUnlockedStage >= gameConfig.totalStages) return;
        let allClearedInCurrentBlock = true;
        const currentBlockStart = Math.floor((lastUnlockedStage - 1) / gameConfig.stagesPerBlock) * gameConfig.stagesPerBlock + 1;
        const currentBlockEnd = currentBlockStart + gameConfig.stagesPerBlock - 1;
        for (let i = currentBlockStart; i <= Math.min(lastUnlockedStage, currentBlockEnd); i++) {
            if (!playerData.stageClears[`stage-${i}`] || playerData.stageClears[`stage-${i}`] === 0) {
                allClearedInCurrentBlock = false;
                break;
            }
        }
        if (allClearedInCurrentBlock && lastUnlockedStage < currentBlockEnd) {
             const newUnlockedStage = lastUnlockedStage + 1;
             playerData.unlockedStage = Math.min(newUnlockedStage, gameConfig.totalStages);
             saveData();
             showCustomAlert(`ãŠã‚ã§ã¨ã†ï¼ã‚¹ãƒ†ãƒ¼ã‚¸${playerData.unlockedStage}ãŒè§£æ”¾ã•ã‚ŒãŸã‚ˆï¼`);
        }
    }

    function checkAndUnlockNextStageBlock(testId) {
        const [_, testStartStr, testEndStr] = testId.split('-');
        const testEndStage = parseInt(testEndStr);
        const nextBlockStartStage = testEndStage + 1;
        if (nextBlockStartStage > gameConfig.totalStages) return;
        const nextBlockEndStage = Math.min(nextBlockStartStage + gameConfig.stagesPerBlock - 1, gameConfig.totalStages);
        if (playerData.unlockedStage < nextBlockStartStage) {
            playerData.unlockedStage = nextBlockEndStage;
            saveData();
            showCustomAlert(`ãŠã‚ã§ã¨ã†ï¼ã‚¹ãƒ†ãƒ¼ã‚¸${nextBlockStartStage}ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¸${nextBlockEndStage}ãŒè§£æ”¾ã•ã‚ŒãŸã‚ˆï¼`);
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function addEventListeners() {
        goToStageSelectButton.addEventListener('click', showStageSelect);
        goToItemExchangeButton.addEventListener('click', showItemExchange);
        goToHistoryButton.addEventListener('click', showExchangeHistoryScreen);
        goToOilyouModeButton.addEventListener('click', () => startQuiz('oilyou', false));

        document.getElementById('back-to-menu-from-stage-select').addEventListener('click', showMainMenu);
        document.getElementById('back-to-menu-from-exchange').addEventListener('click', showMainMenu);
        backToExchangeButton.addEventListener('click', showItemExchange);
        
        readingComprehensionStageButton.addEventListener('click', () => {
             const startStage = rcStartStageSelect.value;
            const endStage = rcEndStageSelect.value;
            if (parseInt(startStage) > parseInt(endStage)) {
                 showCustomAlert('é–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ã¯çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ˆã‚Šå¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã§ãã¾ã›ã‚“ã€‚');
                 return;
            }
            const stageId = `reading-comprehension-${startStage}-${endStage}`;
            startQuiz(stageId, false);
        });

        rcStartStageSelect.addEventListener('change', () => {
            const startStage = parseInt(rcStartStageSelect.value);
            const endStage = parseInt(rcEndStageSelect.value);
            if (startStage > endStage) {
                rcEndStageSelect.value = startStage;
            }
        });

        backToStageSelectButton.addEventListener('click', () => {
            if (isOilyouMode) {
                showMainMenu();
            } else {
                showStageSelect();
            }
        });
        allRetryButton.addEventListener('click', () => {
            if (currentStageId) {
                startQuiz(currentStageId, false);
            }
        });
        retryButton.addEventListener('click', () => {
            if (currentStageId) startQuiz(currentStageId, true);
        });
        exportButton.addEventListener('click', exportData);
        importButton.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData);
    }

    function initApp() {
        loadData();
        loadOilyouProgress();
        if (!window.appInitialized) {
            addEventListeners();
            window.appInitialized = true;
        }
        showMainMenu();
    }

    document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>